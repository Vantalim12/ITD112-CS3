rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to safely get user role (only if document exists)
    function getUserRole() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role 
        : 'viewer';
    }
    
    // Helper function to check if user is admin (only check if user doc exists)
    function isAdmin() {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is admin or analyst
    function isAdminOrAnalyst() {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'dataAnalyst'];
    }
    
    // Users collection - users can create their own profile, admins can manage all
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
      allow delete: if isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Destinations collection - emigration destination data
    match /destinations/{destinationId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Age groups collection
    match /ageGroups/{ageGroupId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Countries collection
    match /countries/{countryId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Civil status collection
    match /civilStatus/{civilStatusId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Education collection
    match /education/{educationId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Occupation collection
    match /occupations/{occupationId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Place of origin collection
    match /placeOfOrigin/{placeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Sex/Gender collection
    match /sex/{sexId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ML Models metadata - stored in Firestore for sharing and backup
    match /mlModels/{modelId} {
      allow read: if isAuthenticated();
      allow create: if isAdminOrAnalyst();
      allow update: if isAuthenticated() && (
        isAdmin() || 
        (isAdminOrAnalyst() && resource.data.createdBy == request.auth.uid)
      );
      allow delete: if isAuthenticated() && (
        isAdmin() || 
        (isAdminOrAnalyst() && resource.data.createdBy == request.auth.uid)
      );
    }
    
    // Audit logs - for tracking sensitive operations
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Logs are immutable
    }
    
    // Uploaded files metadata
    match /uploads/{uploadId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // Emigrant data collections - for dashboard and visualizations
    match /emigrantData_destination/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /emigrantData_province/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /emigrantData_age/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /emigrantData_civilStatus/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /emigrantData_education/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /emigrantData_occupation/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /emigrantData_sex/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Uploaded CSV files metadata
    match /uploadedCSVFiles/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
